---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { FoundationDocumentProcessor } from "@/components/FoundationDocumentProcessor/index";
import { FileText, CloudUpload } from "lucide-react";
import { ORCHESTRATION_API_URL } from "@/server-constants";
import { buttonVariants } from "@/components/ui/button";
import { cn, withBasePath } from "@/lib/utils";

interface ValidationResult {
  present?: string[];
  missing?: string[];
  confidence?: number;
  extracted_data?: unknown[];
}

// Get document UUID or job ID from query parameters
const documentId = Astro.url.searchParams.get("doc");
const jobId = Astro.url.searchParams.get("job");

// If neither is present, redirect to home
if (!documentId && !jobId) {
  return Astro.redirect(withBasePath("/"), 302);
}

// Get validation result from backend API
let validationData: ValidationResult | null = null;
let sourceDocumentId: string | undefined = undefined;

try {
  // Prefer document UUID (persists after restart) over job ID (in-memory)
  if (documentId) {
    const response = await fetch(
      `${ORCHESTRATION_API_URL}/documents/status-by-source/${documentId}`
    );
    if (response.ok) {
      const result = await response.json();
      validationData = result.validationResult;
      sourceDocumentId = documentId;
    }
  } else if (jobId) {
    const response = await fetch(`${ORCHESTRATION_API_URL}/documents/status/${jobId}`);
    if (response.ok) {
      const result = await response.json();
      validationData = result.validationResult;
      sourceDocumentId = result.directusSourceDocumentId;
    }
  }
} catch (error) {
  console.error("Error fetching validation data:", error);
}
---

<BaseLayout title="Augmentace dokumentu" currentStep="download">
  <div class="container mx-auto py-8">
    <div class="text-center mb-8">
      <div class="text-primary w-20 h-20 mx-auto mb-6 flex items-center justify-center" aria-hidden="true">
        <FileText className="w-20 h-20" />
      </div>
      <h1 class="text-4xl font-bold tracking-tight mb-4">Augmentace dokumentu</h1>
      <p class="text-lg text-muted-foreground">
        Automatické doplnění extrahovaných dat do dokumentu
      </p>
    </div>

    <div class="max-w-6xl mx-auto space-y-8">
      {validationData && validationData.extracted_data && validationData.extracted_data.length > 0 ? (
        <FoundationDocumentProcessor 
          client:load 
          documentId={sourceDocumentId ?? undefined} 
          jobId={jobId ?? undefined}
          autoTrigger={true}
        />
      ) : (
        <div class="bg-yellow-50 dark:bg-yellow-950/20 border border-yellow-200 dark:border-yellow-900 rounded-lg p-6 text-center">
          <p class="text-yellow-800 dark:text-yellow-200">
            Nebyla nalezena žádná extrahovaná data pro zpracování.
          </p>
          <a
            href={withBasePath("/upload")}
            class={cn(buttonVariants({ variant: "secondary", size: "lg" }), "mt-4")}
          >
            Nahrát jiný dokument
          </a>
        </div>
      )}

      <!-- Additional Actions -->
      <div class="flex justify-center pt-8">
        <a
          href={withBasePath("/upload")}
          class={buttonVariants({ variant: "secondary", size: "lg" })}
        >
          <CloudUpload className="w-5 h-5" />
          Nahrát další dokument
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

