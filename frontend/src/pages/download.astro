---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/card';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';

// Get job ID from query parameters
const jobId = Astro.url.searchParams.get('job');

if (!jobId) {
  return Astro.redirect('/', 302);
}

// Simulate completed job data for demo
const hasError = false;
const errorMessage = '';

const jobData = {
  id: jobId,
  originalFileName: 'sample-data.csv',
  completedAt: new Date().toISOString(),
  processingTime: '2 minutes 34 seconds',
  results: [
    {
      id: 'processed-data',
      name: 'Zpracovaná data',
      description: 'Váš původní soubor se zpracovanými daty',
      fileName: 'processed-sample-data.csv',
      fileSize: '2.4 MB',
      downloadUrl: `/api/download/${jobId}/processed-data.csv`,
      type: 'primary'
    },
    {
      id: 'summary-report',
      name: 'Souhrnná zpráva',
      description: 'Statistický přehled a analýza',
      fileName: 'summary-report.pdf',
      fileSize: '1.2 MB',
      downloadUrl: `/api/download/${jobId}/summary-report.pdf`,
      type: 'secondary'
    },
    {
      id: 'processing-log',
      name: 'Protokol zpracování',
      description: 'Detailní záznam kroků zpracování',
      fileName: 'processing-log.txt',
      fileSize: '45 KB',
      downloadUrl: `/api/download/${jobId}/processing-log.txt`,
      type: 'secondary'
    }
  ],
  metadata: {
    recordsProcessed: 15847,
    recordsValidated: 15720,
    recordsWithErrors: 127,
    processingEngine: 'Directus v9.2.1'
  }
};
---

<BaseLayout title="Stažení výsledků" currentStep="download">
  <div class="container mx-auto py-8">
    {hasError ? (
      <div class="max-w-2xl mx-auto text-center space-y-6">
        <div class="text-destructive w-16 h-16 mx-auto" aria-hidden="true">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
        <h1 class="text-4xl font-bold tracking-tight text-destructive">Nelze načíst výsledky</h1>
        <p class="text-lg text-muted-foreground">{errorMessage}</p>
        <div class="flex justify-center gap-4">
          <Button asChild>
            <a href="/">Začít nové nahrávání</a>
          </Button>
          <Button variant="secondary" onClick={() => window.location.reload()}>Zkusit znovu</Button>
        </div>
      </div>
    ) : (
      <>
        <div class="text-center mb-8">
          <div class="text-primary w-20 h-20 mx-auto mb-6" aria-hidden="true">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22,4 12,14.01 9,11.01"></polyline>
            </svg>
          </div>
          <h1 class="text-4xl font-bold tracking-tight mb-4">Zpracování dokončeno!</h1>
          <p class="text-lg text-muted-foreground">
            Váš soubor byl úspěšně zpracován. Stáhněte si výsledky níže.
          </p>
        </div>
    
        <div class="max-w-6xl mx-auto space-y-8">
          <!-- Job Summary -->
          <Card>
            <CardHeader>
              <CardTitle>Přehled zpracování</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <span class="text-sm font-medium text-muted-foreground">Původní soubor:</span>
                  <p class="font-medium">{jobData?.originalFileName || 'Neznámý'}</p>
                </div>
                <div class="space-y-2">
                  <span class="text-sm font-medium text-muted-foreground">Dokončeno:</span>
                  <time datetime={jobData?.completedAt || ''} class="font-medium">
                    {jobData?.completedAt ? new Date(jobData.completedAt).toLocaleString() : 'Neznámý čas'}
                  </time>
                </div>
                <div class="space-y-2">
                  <span class="text-sm font-medium text-muted-foreground">Doba zpracování:</span>
                  <p class="font-medium">{jobData?.processingTime || 'Neznámá'}</p>
                </div>
                <div class="space-y-2">
                  <span class="text-sm font-medium text-muted-foreground">ID úlohy:</span>
                  <code class="font-mono text-sm bg-muted px-2 py-1 rounded">{jobData?.id || 'Neznámé'}</code>
                </div>
              </div>
            </CardContent>
          </Card>
          
          <!-- Processing Statistics -->
          <Card>
            <CardHeader>
              <CardTitle>Statistiky zpracování</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <div class="text-center space-y-2">
                  <div class="text-3xl font-bold text-primary">{(jobData?.metadata?.recordsProcessed ?? 0).toLocaleString()}</div>
                  <div class="text-sm font-medium text-muted-foreground">Zpracovaných záznamů</div>
                </div>
                <div class="text-center space-y-2">
                  <div class="text-3xl font-bold text-primary">{(jobData?.metadata?.recordsValidated ?? 0).toLocaleString()}</div>
                  <div class="text-sm font-medium text-muted-foreground">Validovaných záznamů</div>
                </div>
                <div class="text-center space-y-2">
                  <div class="text-3xl font-bold text-primary">{(jobData?.metadata?.recordsWithErrors ?? 0).toLocaleString()}</div>
                  <div class="text-sm font-medium text-muted-foreground">Záznamů s chybami</div>
                </div>
              </div>
            </CardContent>
          </Card>
          
          <!-- Download Files -->
          <Card>
            <CardHeader>
              <CardTitle>Stažení souborů</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {(jobData?.results || []).map((result) => (
                <div class={`flex items-center justify-between p-4 border rounded-lg ${result.type === 'primary' ? 'border-primary bg-primary/5' : 'border-border'}`}>
                  <div class="flex items-center gap-4 flex-1">
                    <div class="text-primary" aria-hidden="true">
                      {result.type === 'primary' ? (
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                          <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                      ) : (
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                          <polyline points="14,2 14,8 20,8"></polyline>
                          <line x1="16" y1="13" x2="8" y2="13"></line>
                          <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                      )}
                    </div>
                    <div class="flex-1">
                      <h3 class="font-semibold">{result.name}</h3>
                      <p class="text-sm text-muted-foreground mb-1">{result.description}</p>
                      <div class="flex gap-4 text-sm text-muted-foreground">
                        <span class="font-mono">{result.fileName}</span>
                        <span>{result.fileSize}</span>
                      </div>
                    </div>
                    {result.type === 'primary' && (
                      <Badge variant="default">Primary</Badge>
                    )}
                  </div>
                  <Button asChild>
                    <a 
                      href={result.downloadUrl} 
                      download={result.fileName}
                      aria-label={`Download ${result.name}`}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7,10 12,15 17,10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                      </svg>
                      Stáhnout
                    </a>
                  </Button>
                </div>
              ))}
              
              <!-- Bulk Download -->
              <div class="pt-4 border-t">
                <div class="flex justify-center">
                  <Button size="lg" id="download-all">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7,10 12,15 17,10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Stáhnout všechny soubory
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
          
          <!-- Additional Actions -->
          <Card>
            <CardHeader>
              <CardTitle>Co dál?</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <Button variant="outline" asChild className="h-auto p-6 flex-col space-y-2">
                  <a href="/">
                    <div class="text-primary mb-2" aria-hidden="true">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="12" y1="11" x2="12" y2="17"></line>
                        <polyline points="9,14 12,17 15,14"></polyline>
                      </svg>
                    </div>
                    <div class="text-center">
                      <h3 class="font-semibold mb-1">Zpracovat další soubor</h3>
                      <p class="text-sm text-muted-foreground">Nahrát a zpracovat nový soubor</p>
                    </div>
                  </a>
                </Button>
                
                <Button variant="outline" className="h-auto p-6 flex-col space-y-2" id="share-results">
                  <div class="text-primary mb-2" aria-hidden="true">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="18" cy="5" r="3"></circle>
                      <circle cx="6" cy="12" r="3"></circle>
                      <circle cx="18" cy="19" r="3"></circle>
                      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                  </div>
                  <div class="text-center">
                    <h3 class="font-semibold mb-1">Sdílet výsledky</h3>
                    <p class="text-sm text-muted-foreground">Vytvořit odkaz pro sdílení těchto výsledků</p>
                  </div>
                </Button>
                
                <Button variant="outline" className="h-auto p-6 flex-col space-y-2" id="save-to-account">
                  <div class="text-primary mb-2" aria-hidden="true">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                  </div>
                  <div class="text-center">
                    <h3 class="font-semibold mb-1">Uložit do účtu</h3>
                    <p class="text-sm text-muted-foreground">Uložit tyto výsledky do vašeho účtu pro pozdější přístup</p>
                  </div>
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
        
        <!-- File Retention Notice -->
        <div class="flex items-center justify-center gap-2 text-sm text-muted-foreground bg-muted p-3 rounded-lg max-w-md mx-auto">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4"></path>
            <path d="M12 8h.01"></path>
          </svg>
          Soubory budou k dispozici ke stažení po dobu 30 dnů. Stáhněte si je prosím co nejdříve.
        </div>
      </>
    )}
  </div>
</BaseLayout>

<script>
  document.addEventListener('astro:page-load', () => {
    const downloadAllBtn = document.getElementById('download-all');
    const shareResultsBtn = document.getElementById('share-results');
    const saveToAccountBtn = document.getElementById('save-to-account');
    
    // Download all files functionality
    if (downloadAllBtn) {
      downloadAllBtn.addEventListener('click', () => {
        // In a real implementation, this would create a ZIP file or trigger multiple downloads
        const downloadLinks = document.querySelectorAll('.download-btn');
        
        downloadLinks.forEach((link, index) => {
          setTimeout(() => {
            (link as HTMLAnchorElement).click();
          }, index * 500); // Stagger downloads to avoid browser blocking
        });
      });
    }
    
    // Share results functionality
    if (shareResultsBtn) {
      shareResultsBtn.addEventListener('click', () => {
        // In a real implementation, this would generate a shareable link
        if (navigator.share) {
          navigator.share({
            title: 'Processing Results',
            text: 'Check out my file processing results',
            url: window.location.href
          }).catch(console.error);
        } else {
          // Fallback: copy URL to clipboard
          navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Link copied to clipboard!');
          }).catch(console.error);
        }
      });
    }
    
    // Save to account functionality
    if (saveToAccountBtn) {
      saveToAccountBtn.addEventListener('click', () => {
        // In a real implementation, this would save results to user account
        alert('This feature would save results to your account for later access.');
      });
    }
  });
</script>
