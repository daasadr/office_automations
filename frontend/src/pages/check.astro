---
import BaseLayout from "../layouts/BaseLayout.astro";
import { ValidationResults } from "../components/ValidationResults";
import { ORCHESTRATION_API_URL } from "../constants";

// Get job ID from query parameters
const jobId = Astro.url.searchParams.get("job");

// If no job ID is present, redirect to upload page
if (!jobId) {
  return Astro.redirect("/upload", 302);
}

// Get validation result from backend API
let validationData = null;

try {
  const response = await fetch(`${ORCHESTRATION_API_URL}/documents/status/${jobId}`);
  if (response.ok) {
    validationData = await response.json();
  }
} catch (error) {
  console.error("Error fetching validation data:", error);
}

// If no validation data found, redirect to upload page
if (!validationData || !validationData.validationResult) {
  return Astro.redirect("/upload", 302);
}

// Extract the data from the backend response
const {
  present: presentItems,
  missing: missingItems,
  confidence: confidenceScore,
} = validationData.validationResult;
---

<BaseLayout title="Kontrola dokumentu" currentStep="check">
  <div class="container mx-auto py-8">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold tracking-tight mb-4">Kontrola dokumentu</h1>
      <p class="text-lg text-muted-foreground">
        Výsledky analýzy vašeho PDF dokumentu
      </p>
    </div>
    
    <div class="max-w-6xl mx-auto space-y-8">
      <!-- Validation Results -->
      <ValidationResults 
        client:load
        present={presentItems}
        missing={missingItems}
        confidence={confidenceScore}
      />

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-4 justify-center items-center mt-12">
        <a
          href="/upload"
          class="inline-flex items-center justify-center gap-2 px-6 py-3 text-base font-medium text-muted-foreground bg-secondary rounded-lg hover:bg-secondary/80 transition-colors min-w-48"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Nahrát jiný dokument
        </a>
        
        <a
          href={`/download?job=${jobId}`}
          class="inline-flex items-center justify-center gap-2 px-6 py-3 text-base font-medium text-white bg-primary rounded-lg hover:bg-primary/90 transition-colors shadow-lg hover:shadow-xl min-w-48"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
          </svg>
          Pokračovat ke stažení
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

