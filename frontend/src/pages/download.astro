---
import BaseLayout from "../layouts/BaseLayout.astro";
import { Card, CardContent, CardHeader, CardTitle } from "../components/ui/card";
import { Button } from "../components/ui/button";
import { Badge } from "../components/ui/badge";
import { ORCHESTRATION_API_URL } from "../constants";
import ExcelDownloadButton from "../components/ExcelDownloadButton";

// Get job ID from query parameters
const jobId = Astro.url.searchParams.get("job");

if (!jobId) {
  return Astro.redirect("/", 302);
}

// Get validation result from backend API
let validationData = null;

try {
  const response = await fetch(`${ORCHESTRATION_API_URL}/documents/status/${jobId}`);
  if (response.ok) {
    const result = await response.json();
    validationData = result.validationResult;
  }
} catch (error) {
  console.error("Error fetching validation data:", error);
}
---

<BaseLayout title="Stažení výsledků" currentStep="download">
  <div class="container mx-auto py-8">
      <>
        <div class="text-center mb-8">
          <div class="text-primary w-20 h-20 mx-auto mb-6" aria-hidden="true">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22,4 12,14.01 9,11.01"></polyline>
            </svg>
          </div>
          <h1 class="text-4xl font-bold tracking-tight mb-4">Zpracování dokončeno!</h1>
          <p class="text-lg text-muted-foreground">
            Váš soubor byl úspěšně zpracován. Stáhněte si výsledky níže.
          </p>
        </div>
    
        <div class="max-w-6xl mx-auto space-y-8">
          <Card>
            <CardHeader>
              <CardTitle>Stažení souborů</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <!-- Excel Download - Primary Option -->
              {validationData && validationData.extracted_data && validationData.extracted_data.length > 0 && (
                <div class="flex items-center justify-between p-4 border border-primary bg-primary/5 rounded-lg">
                  <div class="flex items-center gap-4 flex-1">
                    <div class="text-primary" aria-hidden="true">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <path d="M8 13h2m-2 4h4m-4-8h4"></path>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <h3 class="font-semibold">Excel soubor s extrahovanými daty</h3>
                      <p class="text-sm text-muted-foreground mb-1">Strukturovaná data z PDF organizovaná podle kódů odpadů</p>
                      <div class="flex gap-4 text-sm text-muted-foreground">
                        <span class="font-mono">odpady_{jobId}_{new Date().toISOString().split('T')[0]}.xlsx</span>
                    <Badge variant="default">Více listů</Badge>
                      </div>
                    </div>
                  </div>
                  <ExcelDownloadButton client:load jobId={jobId} />
                </div>
              )}
            </CardContent>
          </Card>
        </div>
      </>
  </div>
</BaseLayout>

