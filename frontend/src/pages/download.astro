---
import BaseLayout from "../layouts/BaseLayout.astro";
import { FoundationDocumentProcessor } from "../components/FoundationDocumentProcessor";
import { ORCHESTRATION_API_URL } from "../constants";

interface ValidationResult {
  present?: string[];
  missing?: string[];
  confidence?: number;
  extracted_data?: unknown[];
}

// Get document UUID or job ID from query parameters
const documentId = Astro.url.searchParams.get("doc");
const jobId = Astro.url.searchParams.get("job");

// If neither is present, redirect to home
if (!documentId && !jobId) {
  return Astro.redirect("/", 302);
}

// Get validation result from backend API
let validationData: ValidationResult | null = null;
let sourceDocumentId: string | undefined = undefined;

try {
  // Prefer document UUID (persists after restart) over job ID (in-memory)
  if (documentId) {
    const response = await fetch(
      `${ORCHESTRATION_API_URL}/documents/status-by-source/${documentId}`
    );
    if (response.ok) {
      const result = await response.json();
      validationData = result.validationResult;
      sourceDocumentId = documentId;
    }
  } else if (jobId) {
    const response = await fetch(`${ORCHESTRATION_API_URL}/documents/status/${jobId}`);
    if (response.ok) {
      const result = await response.json();
      validationData = result.validationResult;
      sourceDocumentId = result.directusSourceDocumentId;
    }
  }
} catch (error) {
  console.error("Error fetching validation data:", error);
}
---

<BaseLayout title="Zpracování zakládacího dokumentu" currentStep="download">
  <div class="container mx-auto py-8">
    <div class="text-center mb-8">
      <div class="text-primary w-20 h-20 mx-auto mb-6" aria-hidden="true">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14,2 14,8 20,8"></polyline>
          <path d="M8 13h2m-2 4h4m-4-8h4"></path>
        </svg>
      </div>
      <h1 class="text-4xl font-bold tracking-tight mb-4">Augmentace dokumentu</h1>
      <p class="text-lg text-muted-foreground">
        Probíhá automatické doplnění extrahovaných dat do zakládacího dokumentu
      </p>
    </div>

    <div class="max-w-6xl mx-auto space-y-8">
      {validationData && validationData.extracted_data && validationData.extracted_data.length > 0 ? (
        <FoundationDocumentProcessor 
          client:load 
          documentId={sourceDocumentId ?? undefined} 
          jobId={jobId ?? undefined}
          autoTrigger={true}
        />
      ) : (
        <div class="bg-yellow-50 dark:bg-yellow-950/20 border border-yellow-200 dark:border-yellow-900 rounded-lg p-6 text-center">
          <p class="text-yellow-800 dark:text-yellow-200">
            Nebyla nalezena žádná extrahovaná data pro zpracování.
          </p>
          <a
            href="/upload"
            class="inline-flex items-center justify-center gap-2 px-6 py-3 mt-4 text-base font-medium text-primary bg-primary/10 rounded-lg hover:bg-primary/20 transition-colors"
          >
            Nahrát jiný dokument
          </a>
        </div>
      )}

      <!-- Additional Actions -->
      <div class="flex justify-center pt-8">
        <a
          href="/upload"
          class="inline-flex items-center justify-center gap-2 px-6 py-3 text-base font-medium text-muted-foreground bg-secondary rounded-lg hover:bg-secondary/80 transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Nahrát jiný dokument
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

